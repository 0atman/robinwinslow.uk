<!doctype html>

<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

     	<title>Fix Docker's networking DNS config | by Robin</title>

    	<meta name="description" content="Within certain networks, docker is unable to resolve DNS correctly. When this happens, here's how to fix it.">
        <meta name="viewport" content="width=device-width">

        <link rel="canonical" href="https://robinwinslow.uk/2016/06/23/fix-docker-networking-dns/" />

        <link type="text/css" rel="stylesheet" href="/assets/global-cde306f7329733dd6abd0056b28c2061da3b79079c896e4286449114bfff9d39.css">

        <script>
            if (location.hostname=="robinwinslow.uk") {
                var _gaq=[
                    ['_require', 'inpage_linkid', '//www.google-analytics.com/plugins/ga/inpage_linkid.js'],
                    ['_setAccount','UA-2993676-8'],
                    ['_trackPageview']
                ];
                (function() {
                    var ga = document.createElement('script');
                    ga.type = 'text/javascript';
                    ga.async = true;
                    ga.src = '//www.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            }
        </script>

        <link type="application/atom+xml" rel="alternative" href="/rss.xml" />
    </head>

    <body class="">
        <!--[if lt IE 9]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/?locale=en">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <header class="site-header">
            <h1>The blog of <a href="/">Robin</a></h1>

            <nav class="inline-navigation site-navigation">
                <ul>
                    <li class=""><a href="/dev/">Web dev</a></li>
                    <li class=""><a href="/politics/">Politics</a></li>
                    <li class=""><a href="/musings/">Musings</a></li>
                    <li class=""><a href="/">All articles</a></li>
                </ul>
            </nav>
        </header>

        <article>
    <header class="page-header">
        <date>23 Jun 2016</date>

        <h1>Fix Docker's networking DNS config</h1>
    </header>

    <p>Sometimes, <a href="https://www.docker.com/">Docker</a>&#39;s internet connectivity won&#39;t be working properly, which can lead to a number of obscure errors with your applications. In my experience, this is usually because <a href="http://en.wikipedia.org/wiki/Domain_name_system">DNS</a> lookups are failing in Docker images.</p>

<p>If you <em>know</em> it&#39;s a DNS problem and you&#39;re in a hurry, <a href="#the-permanent-system-wide-fix">jump straight to the system-wide solution</a>.</p>

<h1 id="is-dns-the-problem">Is DNS the problem?</h1>

<p>eeeeFortunately it&#39;s easy to test Docker&#39;s DNS.</p>

<p>First, check that basic internet connectivity is working by pinging a public IP address. It should succeed, giving you output similar to this:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ docker run busybox ping -c 1 192.203.230.10  # Ping a London-based NASA root nameserver
PING 192.203.230.10 (192.203.230.10): 56 data bytes
64 bytes from 192.203.230.10: seq=0 ttl=53 time=113.866 ms

--- 192.203.230.10 ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 113.866/113.866/113.866 ms

</code></pre></div>
<p>But now try resolving the domain <code>google.com</code>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ docker run busybox nslookup google.com
Server:    8.8.8.8
Address 1: 8.8.8.8
nslookup: can't resolve 'google.com'

</code></pre></div>
<p>If it fails as shown above then there is a problem resolving DNS.</p>

<h1 id="why">Why?</h1>

<p>By default, if Docker can&#39;t find a DNS server locally defined in your <code>/etc/resolv.conf</code> file, <a href="https://docs.docker.com/engine/userguide/networking/configure-dns/">containers will default</a> to using <a href="https://developers.google.com/speed/public-dns/">Google&#39;s public DNS server</a>, <code>8.8.8.8</code>, to resolve DNS.</p>

<p>In some networks, like <a href="http://www.canonical.com/about#office-row">Canonical&#39;s London office</a> network where I work, the administrators intentionally block the use of public DNS servers to encourage people to use the network&#39;s own DNS server.</p>

<p>In this case, Docker containers using the default configuration won&#39;t be able to resolve DNS, rendering the internet effectively unuseable from within those containers.</p>

<p>I&#39;ve <a href="https://github.com/docker/docker/issues/23910">filed a bug about this issue</a>, although I don&#39;t yet know when or if it might be addressed.</p>

<h1 id="the-quick-fix-overriding-dockers-dns">The quick fix: Overriding Docker&#39;s DNS</h1>

<p>Fortunately, it&#39;s fairly easy to directly run a docker container with a custom DNS server.</p>

<h2 id="discover-the-address-of-your-dns-server">Discover the address of your DNS server</h2>

<p>You can find out what network&#39;s DNS server from within <a href="http://www.ubuntu.com/">Ubuntu</a> as follows:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ nmcli dev show | grep 'IP4.DNS'
IP4.DNS[1]:                             10.0.0.2

</code></pre></div>
<h2 id="run-docker-with-the-new-dns-server">Run Docker with the new DNS server</h2>

<p>To run a docker container with this DNS server, provide the <code>--dns</code> flag to the <code>run</code> command. For example, let&#39;s run the command we used to check if DNS is working:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ docker run --dns 10.0.0.2 busybox nslookup google.com
Server:    10.0.0.2
Address 1: 10.0.0.2
Name:      google.com
Address 1: 2a00:1450:4009:811::200e lhr26s02-in-x200e.1e100.net
Address 2: 216.58.198.174 lhr25s10-in-f14.1e100.net

</code></pre></div>
<p>And that&#39;s what success looks like.</p>

<h1 id="the-permanent-system-wide-fix">The permanent system-wide fix</h1>

<p>The above solution is all very well if you&#39;re only temporarily inside a restrictive network and you only need to run containers directly.</p>

<p>However, most of the time you&#39;ll want this to work by default and keep working on your system, and for any other programs that rely on Docker.</p>

<h2 id="update-the-docker-daemon">Update the Docker daemon</h2>

<p>To achieve this, you need to change the DNS settings of the Docker daemon. You can set the default options for the docker daemon by creating a <a href="https://docs.docker.com/engine/reference/commandline/dockerd/#/daemon-configuration-file">daemon configuration file</a> at <code>/etc/docker/daemon.json</code>.</p>

<p>You should create this file with the following contents to set two DNS, firstly your network&#39;s DNS server, and secondly the Google DNS server to fall back to in case that server isn&#39;t available:</p>

<p><code>/etc/docker/daemon.json</code>:</p>
<div class="highlight"><pre><code class="language-" data-lang=""><span class="p">{</span><span class="w">
    </span><span class="nt">"dns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"10.0.0.2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"8.8.8.8"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div>
<p>Then restart the docker service:</p>
<div class="highlight"><pre><code class="language-" data-lang="">sudo service docker restart

</code></pre></div>
<h2 id="testing-the-fix">Testing the fix</h2>

<p>Now you should be able to ping <code>google.com</code> successfully from any Docker container without explicitly overriding the DNS server, e.g.:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ docker run busybox nslookup google.com
Server:    10.0.0.2
Address 1: 10.0.0.2
Name:      google.com
Address 1: 2a00:1450:4009:811::200e lhr26s02-in-x200e.1e100.net
Address 2: 216.58.198.174 lhr25s10-in-f14.1e100.net

</code></pre></div>

<!-- Generate subnav for article -->
<script type="text/javascript" src="/assets/subnav-020636817964deb048fb98c55583f2981ff145d2db5e13d5c3b624c4ef8613f4.js"></script>


    <hr>

    <nav class="tags-list muted">
        <label>Tags</label>

        <ul>

            <li><a href="/postsbytag/#back-end">back-end</a></li>

            <li><a href="/postsbytag/#dev">dev</a></li>

            <li><a href="/postsbytag/#canonical">canonical</a></li>

        </ul>
    </nav>


<hr/>

<div id="disqus_thread" class="comments"></div>

</article>


<nav class="related-nav article-index">
    <h1>Similar articles</h1>

    <ul>
    
        
            
        
            
                <li>
    <article>
        <a href="/2016/02/14/simplest-wsgi-application/">
            <date>14 Feb 2016</date>
            <h1>Creating a minimal Python application server for experimenting</h1>
            <p>As a web developer, it can be incredibly useful to be able to spin up a quick server to inspect and manipulate raw requests. And if you're used to working in Python, this little script is just the ticket.</p>
        </a>


        <nav class="tags-list muted">
            <label>Tags</label>

            <ul>

                <li><a href="/postsbytag/#dev">dev</a></li>

                <li><a href="/postsbytag/#back-end">back-end</a></li>

            </ul>
        </nav>

    </article>
</li>

            
        
            
                <li>
    <article>
        <a href="/2015/04/02/installing-docker-on-ubuntu/">
            <date>02 Apr 2015</date>
            <h1>Getting Docker running on Ubuntu 14.04</h1>
            <p>There are more steps than there should be to get docker running on ubuntu 14.04. I outline them here.</p>
        </a>


        <nav class="tags-list muted">
            <label>Tags</label>

            <ul>

                <li><a href="/postsbytag/#dev">dev</a></li>

                <li><a href="/postsbytag/#back-end">back-end</a></li>

            </ul>
        </nav>

    </article>
</li>

            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
    </ul>
</nav>


<script>
    if (location.hostname=="robinwinslow.uk") {
        var disqus_shortname = 'robin-blog'; // required: replace example with your forum shortname

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    }
</script>

<noscript>Please enable JavaScript to view the comments (powered by <a href="http://disqus.com/?ref_noscript">Disqus</a>)</noscript>


        <footer class="site-footer">
            <nav class="vcard" id="contact-information">
                <h1>Contact information</h1>

                <ul>
                    <li><a href="mailto:robin+blog@robinwinslow.uk" class="email">robin@robinwinslow.uk</a></li>
                    <li><a href="tel:07795070704" class="tel">07795070704</a></li>
                    <li><a href="https://www.google.co.uk/maps?q=ng7">NG7, Nottingham, UK</a></li>
                </ul>
            </nav>

            <nav>
                <h1>Further writing</h1>

                <ul>
                    <li><a href="http://cv.robinwinslow.uk">cv.robinwinslow.uk</a></li>
                    <li><a href="http://design.canonical.com/author/nottrobin/">design.canonical.com</a></li>
                    </li>
                </ul>
            </nav>

            <nav>
                <h1>Profiles</h1>

                <ul>
                    <li><a href="https://twitter.com/nottrobin">twitter.com (@nottrobin)</a></li>
                    <li><a href="https://facebook.com/robinwinslowmorris">facebook.com (robinwinslowmorris)</a></li>
                    <li><a href="https://github.com/nottrobin/">github.com (nottrobin)</a>
                </ul>
            </nav>

            <p>
                All articles are written by me, <a href="https://plus.google.com/104026832761488144614" rel="author">Robin Winslow</a>, unless otherwise stated. Feel free to use any of my writing, but please <a href="http://creativecommons.org/licenses/by/4.0/">give me attribution</a>.
            </p>

            <p>You're free to download this entire site <a href="https://github.com/nottrobin/robinwinslow.uk/">from github</a>, and <a href="http://creativecommons.org/publicdomain/zero/1.0/">do whatever you like</a> with the code.</p>

            <p><a href="https://github.com/nottrobin/robinwinslow.uk/" class="github-fork">Fork me on github.</a></p>
        </footer>
		<!--[if !(lt IE 8)]><!-->
		<script type="text/javascript">
		  (function(){
			var e = document.createElement('script'); e.type='text/javascript'; e.async = true;
			e.src = 'https://www.eff.org/ngw/widget.min.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(e, s);
		  })();
		</script>
		<!--<![endif]-->
    </body>
</html>
