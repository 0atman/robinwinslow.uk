server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /srv;

    index index.html;

    # Log to stdout
    access_log /dev/stdout;
    error_log /dev/stderr info;

    # Show 404 page
    error_page 404 /404.html;

    # Show commit-id
    add_header X-Commit-ID ~COMMIT_ID~ always;
    add_header X-Hostname $hostname always;

    server_name _;

    # Remove index or index.html from URIs
    if ($request_uri ~ ^.*/index(.html)?$) {
        rewrite ^(.*/)index(.html)? $1 permanent;
    }

    # Remove slashes form URIs if it's not a directory
    if (!-d $request_filename) {
        rewrite ^/(.*)/$ /$1 permanent;
    }

    # Add slashes from URIs if it's a directory
    if (-d $request_filename) {
        rewrite ^/(.*[^/])$ /$1/ permanent;
    }

    # Redirects to development.robinwinslow.uk
    rewrite ^/dev/?$ https://development.robinwinslow.uk/ permanent;
    rewrite ^/2016/06/23/fix-docker-networking-dns/?$ https://development.robinwinslow.uk/2016/06/23/fix-docker-networking-dns/ permanent;
    rewrite ^/2016/02/25/adding-cache-headers-to-django/?$ https://development.robinwinslow.uk/2016/02/25/adding-cache-headers-to-django/ permanent;
    rewrite ^/2016/02/14/simplest-wsgi-application/?$ https://development.robinwinslow.uk/2016/02/14/simplest-wsgi-application/ permanent;
    rewrite ^/2016/02/13/free-https-custom-hosting/?$ https://development.robinwinslow.uk/2016/02/13/free-https-custom-hosting/ permanent;
    rewrite ^/2015/12/01/common-vagrant-problems/?$ https://development.robinwinslow.uk/2015/12/01/common-vagrant-problems/ permanent;
    rewrite ^/2015/09/29/pycon-python-learnings/?$ https://development.robinwinslow.uk/2015/09/29/pycon-python-learnings/ permanent;
    rewrite ^/2015/09/26/prepare-for-ubuntu-freezing/?$ https://development.robinwinslow.uk/2015/09/26/prepare-for-ubuntu-freezing/ permanent;
    rewrite ^/2015/09/24/pycon-friendly-inspiring/?$ https://development.robinwinslow.uk/2015/09/24/pycon-friendly-inspiring/ permanent;
    rewrite ^/2015/04/02/installing-docker-on-ubuntu/?$ https://development.robinwinslow.uk/2015/04/02/installing-docker-on-ubuntu/ permanent;
    rewrite ^/2015/03/05/a-seachange-in-front-end-best-practice/?$ https://development.robinwinslow.uk/2015/03/05/a-seachange-in-front-end-best-practice/ permanent;
    rewrite ^/2015/01/10/converting-between-git-and-bzr/?$ https://development.robinwinslow.uk/2015/01/10/converting-between-git-and-bzr/ permanent;
    rewrite ^/2015/01/08/project-ideas/?$ https://development.robinwinslow.uk/2015/01/08/project-ideas/ permanent;
    rewrite ^/2014/09/18/markup-on-the-information-superhighway/?$ https://development.robinwinslow.uk/2014/09/18/markup-on-the-information-superhighway/ permanent;
    rewrite ^/2014/08/29/saving-ubuntu-com-download-day/?$ https://development.robinwinslow.uk/2014/08/29/saving-ubuntu-com-download-day/ permanent;
    rewrite ^/2014/08/26/host-your-site-with-https-for-free/?$ https://development.robinwinslow.uk/2014/08/26/host-your-site-with-https-for-free/ permanent;
    rewrite ^/2014/01/10/agile-philosophy/?$ https://development.robinwinslow.uk/2014/01/10/agile-philosophy/ permanent;
    rewrite ^/2014/01/09/php-programming-principles/?$ https://development.robinwinslow.uk/2014/01/09/php-programming-principles/ permanent;
    rewrite ^/2014/01/08/general-coding-guidelines/?$ https://development.robinwinslow.uk/2014/01/08/general-coding-guidelines/ permanent;
    rewrite ^/2014/01/05/summary-of-python-code-style-conventions/?$ https://development.robinwinslow.uk/2014/01/05/summary-of-python-code-style-conventions/ permanent;
    rewrite ^/2013/12/26/python-3-4-virtual-environment/?$ https://development.robinwinslow.uk/2013/12/26/python-3-4-virtual-environment/ permanent;
    rewrite ^/2013/11/22/expressive-coding/?$ https://development.robinwinslow.uk/2013/11/22/expressive-coding/ permanent;
    rewrite ^/2013/10/03/linkchecker/?$ https://development.robinwinslow.uk/2013/10/03/linkchecker/ permanent;
    rewrite ^/2013/06/20/loading-fonts-as-data-urls/?$ https://development.robinwinslow.uk/2013/06/20/loading-fonts-as-data-urls/ permanent;
    rewrite ^/2013/06/15/static-site-generators/?$ https://development.robinwinslow.uk/2013/06/15/static-site-generators/ permanent;
    rewrite ^/2013/06/14/fixing-missing-disqus-comments-through-url-map/?$ https://development.robinwinslow.uk/2013/06/14/fixing-missing-disqus-comments-through-url-map/ permanent;
    rewrite ^/2013/06/11/dont-ever-commit-binary-files-to-git/?$ https://development.robinwinslow.uk/2013/06/11/dont-ever-commit-binary-files-to-git/ permanent;
    rewrite ^/2013/06/07/create-github-repositories-from-the-command-line/?$ https://development.robinwinslow.uk/2013/06/07/create-github-repositories-from-the-command-line/ permanent;
    rewrite ^/2013/05/31/installing-symfony-2-by-creating-a-github-fork/?$ https://development.robinwinslow.uk/2013/05/31/installing-symfony-2-by-creating-a-github-fork/ permanent;
    rewrite ^/2013/05/30/why-i-love-the-internet/?$ https://development.robinwinslow.uk/2013/05/30/why-i-love-the-internet/ permanent;
    rewrite ^/2013/05/29/ease-magento-development-with-bootstrapped-scripts/?$ https://development.robinwinslow.uk/2013/05/29/ease-magento-development-with-bootstrapped-scripts/ permanent;
    rewrite ^/2013/03/05/chrome-v25-breaks-layout-of-date-field/?$ https://development.robinwinslow.uk/2013/03/05/chrome-v25-breaks-layout-of-date-field/ permanent;
    rewrite ^/2013/03/02/awesome-in-site-user-feedback/?$ https://development.robinwinslow.uk/2013/03/02/awesome-in-site-user-feedback/ permanent;
    rewrite ^/2013/02/28/time-to-say-goodbye-to-ie8/?$ https://development.robinwinslow.uk/2013/02/28/time-to-say-goodbye-to-ie8/ permanent;
    rewrite ^/2013/01/18/where-do-i-sign-up-for-the-open-access-movement/?$ https://development.robinwinslow.uk/2013/01/18/where-do-i-sign-up-for-the-open-access-movement/ permanent;
    rewrite ^/2012/12/13/oss-projects-i-d-love-to-get-involved-with/?$ https://development.robinwinslow.uk/2012/12/13/oss-projects-i-d-love-to-get-involved-with/ permanent;
    rewrite ^/2012/12/12/note-to-self-technical-aspirations/?$ https://development.robinwinslow.uk/2012/12/12/note-to-self-technical-aspirations/ permanent;
    rewrite ^/2012/12/07/continuous-improvement-and-tdd-bdd/?$ https://development.robinwinslow.uk/2012/12/07/continuous-improvement-and-tdd-bdd/ permanent;
    rewrite ^/2012/11/16/sass-just-became-feasible/?$ https://development.robinwinslow.uk/2012/11/16/sass-just-became-feasible/ permanent;
    rewrite ^/2012/10/05/what-to-do-if-your-vagrant-vm-crashes/?$ https://development.robinwinslow.uk/2012/10/05/what-to-do-if-your-vagrant-vm-crashes/ permanent;
    rewrite ^/2012/08/06/finding-a-free-version-of-gill-sans/?$ https://development.robinwinslow.uk/2012/08/06/finding-a-free-version-of-gill-sans/ permanent;
    rewrite ^/2012/07/20/tmux-and-ssh-auto-login-with-ssh-agent-finally/?$ https://development.robinwinslow.uk/2012/07/20/tmux-and-ssh-auto-login-with-ssh-agent-finally/ permanent;
    rewrite ^/2012/07/17/installing-vagrant-on-centos-the-more-reliable-way/?$ https://development.robinwinslow.uk/2012/07/17/installing-vagrant-on-centos-the-more-reliable-way/ permanent;
    rewrite ^/2012/07/16/my-piratebay-mirror/?$ https://development.robinwinslow.uk/2012/07/16/my-piratebay-mirror/ permanent;
    rewrite ^/2012/04/10/sending-emails-individually-to-many-people-in-php/?$ https://development.robinwinslow.uk/2012/04/10/sending-emails-individually-to-many-people-in-php/ permanent;
    rewrite ^/2012/04/10/learning-to-scale-svg-icons/?$ https://development.robinwinslow.uk/2012/04/10/learning-to-scale-svg-icons/ permanent;
    rewrite ^/2012/03/13/website-front-end-performance-tips/?$ https://development.robinwinslow.uk/2012/03/13/website-front-end-performance-tips/ permanent;
    rewrite ^/2012/03/13/usable-layout-responsive-design/?$ https://development.robinwinslow.uk/2012/03/13/usable-layout-responsive-design/ permanent;
    rewrite ^/2012/03/13/javascript-closures-passing-an-object-context-to-a-callback-function/?$ https://development.robinwinslow.uk/2012/03/13/javascript-closures-passing-an-object-context-to-a-callback-function/ permanent;
    rewrite ^/2012/03/13/importing-a-csv-file-into-mysql/?$ https://development.robinwinslow.uk/2012/03/13/importing-a-csv-file-into-mysql/ permanent;
    rewrite ^/2012/03/13/css-best-practice-tips/?$ https://development.robinwinslow.uk/2012/03/13/css-best-practice-tips/ permanent;

    # Redirects from before
    rewrite ^/2011/04/06/php-csv-import-script/$ /2012/03/13/importing-a-csv-file-into-mysql/ permanent;
    rewrite ^/tagged/brain-dump$ /postsbytag/#personal/ permanent;
    rewrite ^/2011/07/25/css-good-practice-tips/$ /2012/03/13/css-best-practice-tips/ permanent;
    rewrite ^/tagged/front-end$ /postsbytag/#front-end/ permanent;
    rewrite ^/tagged/typeography$ /postsbytag/#front-end/ permanent;
    rewrite ^/tagged/tmux$ /postsbytag/#unix/ permanent;
    rewrite ^/tagged/open-access$ /postsbytag/#politics/ permanent;
    rewrite ^/page/2$ / permanent;
    rewrite ^/categories$ /postsbytag/ permanent;
    rewrite ^/2011/05/25/javascript-passing-an-object-context-to-a-callback-function/feed/$ /2012/03/13/javascript-closures-passing-an-object-context-to-a-callback-function/ permanent;
    rewrite ^/post/40771096073 /2013/01/18/where-do-i-sign-up-for-the-open-access-movement/ permanent;
    rewrite ^/post/37846002351 /2012/12/13/oss-projects-i-d-love-to-get-involved-with/ permanent;
    rewrite ^/post/37785959903 /2012/12/12/note-to-self-technical-aspirations/ permanent;
    rewrite ^/post/37413262948 /2012/12/07/continuous-improvement-and-tdd-bdd/ permanent;
    rewrite ^/post/37412613737 /2012/12/07/a-blogs-existential-quest/ permanent;
    rewrite ^/post/37117413644 /2012/12/03/an-open-letter-to-avaaz/ permanent;
    rewrite ^/post/35858211521 /2012/11/16/sass-just-became-feasible/ permanent;
    rewrite ^/post/32940333839 /2012/10/05/what-to-do-if-your-vagrant-vm-crashes/ permanent;
    rewrite ^/post/32454555914 /2012/09/28/i-am-a-published-author-of-a-journal-article/ permanent;
    rewrite ^/post/28835090592 /2012/08/06/finding-a-free-version-of-gill-sans/ permanent;
    rewrite ^/post/27629547036 /2012/07/20/tmux-and-ssh-auto-login-with-ssh-agent-finally/ permanent;
    rewrite ^/post/27370485407 /2012/07/17/installing-vagrant-on-centos-the-more-reliable-way/ permanent;
    rewrite ^/post/27354548116 /2012/07/16/my-piratebay-mirror/ permanent;
    rewrite ^/post/27265158526 /2012/07/15/in-opposition-of-the-bankers-behind-bars-campaign/ permanent;
    rewrite ^/post/20811491590 /2012/04/10/learning-to-scale-svg-icons/ permanent;
    rewrite ^/post/20809514118 /2012/04/10/sending-emails-individually-to-many-people-in-php/ permanent;
    rewrite ^/post/19246584777 /2012/03/13/website-front-end-performance-tips/ permanent;
    rewrite ^/post/19246455152 /2012/03/13/css-best-practice-tips/ permanent;
    rewrite ^/post/19246171971 /2012/03/13/javascript-closures-passing-an-object-context-to-a-callback-function/ permanent;
    rewrite ^/post/19244584389 /2012/03/13/importing-a-csv-file-into-mysql/ permanent;
    rewrite ^/post/19244149331 /2012/03/13/blog-ideas/ permanent;
    rewrite ^/post/19243192502 /2012/03/13/usable-layout-responsive-design/ permanent;
    rewrite ^/post/40557407998 /2013/01/18/where-do-i-sign-up-for-the-open-access-movement/ permanent;
    rewrite ^/post/29652660939 /2012/08/06/finding-a-free-version-of-gill-sans/ permanent;

    # For finding files from URIs
    # First try the URI directly, then try adding .html, then try treating it as a directory
    # Finally fall back to 404
    location ~ ^/.+$ {
        try_files $uri $uri.html $uri/ =404;
    }
}
