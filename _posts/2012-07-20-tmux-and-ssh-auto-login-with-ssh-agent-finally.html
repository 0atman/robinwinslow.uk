---
title: tmux and ssh auto-login with ssh-agent (finally!)
layout: post
tags:
  - tmux
  - unix
  - web development
  - ssh

type: regular
---
 
<p>I finally got this working, so I thought I'd blog about it.</p>&#13;
<p>Here's what I wanted to achieve:</p>&#13;
<ol><li>I log in to my unix system via SSH</li>&#13;
<li><a href="http://tmux.sourceforge.net/">tmux</a>, my terminal multiplexer, starts up automatically</li>&#13;
<li>I can then SSH between my environments <strong>without</strong> typing in a password every time.</li>&#13;
</ol><div><!-- more --></div>&#13;
<p>This is harder than you might think, as it requires several things to work together. After reading <a href="http://spin.atomicobject.com/2012/01/28/less-perplexing-terminal-multiplexing-with-tmux/">through</a> <a href="http://dpc.ucore.info/post/14988791712/make-tmux-and-ssh-agent-work-smoothly">loads</a> <a href="http://superuser.com/questions/237822/how-can-i-get-ssh-agent-working-over-ssh-and-in-tmux-on-os-x">of</a> <a href="http://blog.codersbase.com/2012/03/tmux-ssh-agent.html">blog</a> <a href="http://www.opsbs.com/2011/04/terminal-multiplexing-with-ssh-agent-my-tmux-setup/">posts</a> I worked out how to do it:</p>&#13;
<ol><li>A password-less private key setup in your .ssh/ directory (e.g. ~/.ssh/id_dsa)</li>&#13;
<li>The public key added to the authorised_keys for each destination box</li>&#13;
<li>An ssh-agent environment running to automatically forward your keys for SSH connection.</li>&#13;
<li>Make sure you don't spawn a new ssh-agent each time you log in, as you'll end up with hundreds of orphaned processes.</li>&#13;
</ol><p>It was the last step I was struggling with. To setup the first two steps <a href="http://www.thegeekstuff.com/2008/11/3-steps-to-perform-ssh-login-without-password-using-ssh-keygen-ssh-copy-id/">follow the guide here</a>.</p>&#13;
<p>However, if you then don't do the final step, it will always ask for a passphrase for your key whenever you try to SSH:</p>&#13;
<pre>[rwmorris@dev:~] # ssh qa&#13;
Enter passphrase for key '/home/rwmorris/.ssh/id_dsa.pub':</pre>&#13;
<p>For step 3 you need your tmux session to be aware of the ssh-agent environment, which isn't too hard.</p>&#13;
<p>The problem in step for is that, stupidly, ssh-agent processes persist even if you log out of your terminal, and then if you spawn a new one when you log in again you end up with hundreds of orphaned processes and the sysadmins get upset.</p>&#13;
<p>The solution to that is to make sure you start you ssh-agent with the "-a" option to specify the socket it should use, and then make sure you store the process ID (PID) somewhere. That way you can re-set the $SSH_AUTH_SOCK and $SSH_AGENT_PID environment variables to the correct values when you login again, and everything will work.</p>&#13;
<ol><li>Fire up the ssh-agent process before you run your tmux session, making sure you only start a new one if there isn't an existing one already.&#13;
<pre># ~/.bashrc&#13;
&#13;
if [ -z "$TMUX" ]; then&#13;
    # we're not in a tmux session&#13;
    &#13;
    if [ ! -z "$SSH_TTY" ]; then&#13;
        # We logged in via SSH&#13;
        &#13;
        # if ssh auth variable is missing&#13;
        if [ -z "$SSH_AUTH_SOCK" ]; then&#13;
            export SSH_AUTH_SOCK="$HOME/.ssh/.auth_socket"&#13;
        fi&#13;
&#13;
        # if socket is available create the new auth session&#13;
        if [ ! -S "$SSH_AUTH_SOCK" ]; then&#13;
            `ssh-agent -a $SSH_AUTH_SOCK` &gt; /dev/null 2&gt;&amp;1&#13;
            echo $SSH_AGENT_PID &gt; $HOME/.ssh/.auth_pid&#13;
        fi&#13;
&#13;
        # if agent isn't defined, recreate it from pid file&#13;
        if [ -z $SSH_AGENT_PID ]; then&#13;
            export SSH_AGENT_PID=`cat $HOME/.ssh/.auth_pid`&#13;
        fi&#13;
&#13;
        # Add all default keys to ssh auth&#13;
        ssh-add 2&gt;/dev/null&#13;
&#13;
        # start tmux&#13;
        tmux attach&#13;
    fi&#13;
fi</pre>&#13;
</li>&#13;
<li>Make sure tmux is configured to pass through appropriate environment variables so it can find the socket for your ssh-agent session:&#13;
<pre># ~/.tmux.conf&#13;
set -g update-environment -r&#13;
</pre>&#13;
</li>&#13;
</ol><p>And win. Sorry it's not more simple. You'd think a lot of this would be the default use-case so it would just work out of the box, but sadly that's not the way the unix world works.</p> 
