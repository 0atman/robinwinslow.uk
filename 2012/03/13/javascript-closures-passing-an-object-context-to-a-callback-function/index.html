<!doctype html>

<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

     	<title>JavaScript closures &#58; Passing an Object context to a callback function | by Robin</title>

    	<meta name="description" content="A useful application for JavaScript Closures - passing object context.">
        <meta name="viewport" content="width=device-width">

        <link rel="canonical" href="https://robinwinslow.uk/2012/03/13/javascript-closures-passing-an-object-context-to-a-callback-function/" />

        <link type="text/css" rel="stylesheet" href="/assets/global-cde306f7329733dd6abd0056b28c2061da3b79079c896e4286449114bfff9d39.css">

        <script>
            if (location.hostname=="robinwinslow.uk") {
                var _gaq=[
                    ['_require', 'inpage_linkid', '//www.google-analytics.com/plugins/ga/inpage_linkid.js'],
                    ['_setAccount','UA-2993676-8'],
                    ['_trackPageview']
                ];
                (function() {
                    var ga = document.createElement('script');
                    ga.type = 'text/javascript';
                    ga.async = true;
                    ga.src = '//www.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
            }
        </script>

        <link type="application/atom+xml" rel="alternative" href="/rss.xml" />
    </head>

    <body class="">
        <!--[if lt IE 9]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/?locale=en">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <header class="site-header">
            <h1>The blog of <a href="/">Robin</a></h1>

            <nav class="inline-navigation site-navigation">
                <ul>
                    <li class=""><a href="/dev/">Web dev</a></li>
                    <li class=""><a href="/politics/">Politics</a></li>
                    <li class=""><a href="/musings/">Musings</a></li>
                    <li class=""><a href="/">All articles</a></li>
                </ul>
            </nav>
        </header>

        <article>
    <header class="page-header">
        <date>13 Mar 2012</date>

        <h1>JavaScript closures &#58; Passing an Object context to a callback function</h1>
    </header>

    <p>This is the first really useful application for <a href="https://developer.mozilla.org/en/JavaScript/Guide/Closures">JavaScript closures</a> that I&#39;ve found.</p>

<p><a id="problem"></a></p>

<h1 id="the-problem">The problem</h1>

<p>(You can <a href="#solution">skip straight to the solution</a> if you want).</p>

<p>There are many situations when you might use a callback function. For example, to be run after an <a href="https://developer.mozilla.org/en/XMLHttpRequest">XMLHttpRequest</a> (or AJAX call), or on adding an <a href="https://developer.mozilla.org/en/DOM/element.addEventListener">event listener</a>.</p>

<p>It is not uncommon to want to create a callback from within an Object instance, and to want all of the methods and properties of that object to be available to the callback function.</p>

<p>For example (you can try this example out in your browsers JS console if it has one):</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">myOb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aString</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">aString</span> <span class="o">=</span> <span class="nx">aString</span><span class="p">;</span>

    <span class="c1">// Callback for timer</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// We can't use "this" because it is just the window object</span>
        <span class="c1">// But we can access an instance of the object through the global variable</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">globalString</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Attempt to make the object available to the callback by creating a global variable</span>
    <span class="nx">globalString</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">aString</span><span class="p">;</span>

    <span class="c1">// Call the callback function after 1 second</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">obInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">myOb</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">);</span> <span class="c1">// Sets "globalString" to "hello"</span>
<span class="kd">var</span> <span class="nx">anotherObInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">myOb</span><span class="p">(</span><span class="s1">'world'</span><span class="p">);</span> <span class="c1">// Sets "globalString" to "world"</span>
</code></pre></div>
<p>This outputs the following in my Chrome 11 console:</p>
<div class="highlight"><pre><code class="language-" data-lang="">world
world
</code></pre></div>
<p>This is because the global variable &quot;globalString&quot; is initially set to &quot;hello&quot;, but it gets immediately overridden with &quot;world&quot; when the second instance of the object is called. Therefore, by the time the callbacks fire (a second after the page loads) the variable is &quot;world&quot;, so they both return &quot;world&quot;. This could very well be a problem.</p>

<p><a id="solution"></a></p>

<h1 id="the-solution">The solution</h1>

<p>The solution is to set the context (i.e. &#39;this&#39;) of the callback function <code>this.callback</code> to be the current object instance, so that the function will inherently have access to all the object&#39;s properties.</p>

<p>The logic for this is a little complex and I won&#39;t fully explain it here, but in short it uses a <a href="https://developer.mozilla.org/en/JavaScript/Guide/Closures">closure</a> to capture the object instance in the <code>caller</code> variable, and then the <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function/apply">apply</a> method to set the context of the function to be <code>caller</code>.</p>

<p>Here it is (once again feel free to try this in your browser&#39;s console):</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">myOb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aString</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">aString</span> <span class="o">=</span> <span class="nx">aString</span><span class="p">;</span>

    <span class="c1">// Callback for timer</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// The arguement passed to this particular instance of myOb</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">aString</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Call the callback function after 1 second</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">caller</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">caller</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">caller</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">}</span> <span class="p">})(</span><span class="k">this</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">obInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">myOb</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">anotherObInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">myOb</span><span class="p">(</span><span class="s1">'world'</span><span class="p">);</span>
</code></pre></div>
<p>This should successfully output:</p>
<div class="highlight"><pre><code class="language-" data-lang="">hello
world
</code></pre></div>
<p>Problem solved. </p>


<!-- Generate subnav for article -->
<script type="text/javascript" src="/assets/subnav-020636817964deb048fb98c55583f2981ff145d2db5e13d5c3b624c4ef8613f4.js"></script>


    <hr>

    <nav class="tags-list muted">
        <label>Tags</label>

        <ul>

            <li><a href="/postsbytag/#JavaScript">JavaScript</a></li>

            <li><a href="/postsbytag/#dev">dev</a></li>

            <li><a href="/postsbytag/#front-end">front-end</a></li>

        </ul>
    </nav>


<hr/>

<div id="disqus_thread" class="comments"></div>

</article>


<nav class="related-nav article-index">
    <h1>Similar articles</h1>

    <ul>
    
        
            
        
    
    </ul>
</nav>


<script>
    if (location.hostname=="robinwinslow.uk") {
        var disqus_shortname = 'robin-blog'; // required: replace example with your forum shortname

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    }
</script>

<noscript>Please enable JavaScript to view the comments (powered by <a href="http://disqus.com/?ref_noscript">Disqus</a>)</noscript>


        <footer class="site-footer">
            <nav class="vcard" id="contact-information">
                <h1>Contact information</h1>

                <ul>
                    <li><a href="mailto:robin+blog@robinwinslow.uk" class="email">robin@robinwinslow.uk</a></li>
                    <li><a href="tel:07795070704" class="tel">07795070704</a></li>
                    <li><a href="https://www.google.co.uk/maps?q=ng7">NG7, Nottingham, UK</a></li>
                </ul>
            </nav>

            <nav>
                <h1>Further writing</h1>

                <ul>
                    <li><a href="http://cv.robinwinslow.uk">cv.robinwinslow.uk</a></li>
                    <li><a href="http://design.canonical.com/author/nottrobin/">design.canonical.com</a></li>
                    </li>
                </ul>
            </nav>

            <nav>
                <h1>Profiles</h1>

                <ul>
                    <li><a href="https://twitter.com/nottrobin">twitter.com (@nottrobin)</a></li>
                    <li><a href="https://facebook.com/robinwinslowmorris">facebook.com (robinwinslowmorris)</a></li>
                    <li><a href="https://github.com/nottrobin/">github.com (nottrobin)</a>
                </ul>
            </nav>

            <p>
                All articles are written by me, <a href="https://plus.google.com/104026832761488144614" rel="author">Robin Winslow</a>, unless otherwise stated. Feel free to use any of my writing, but please <a href="http://creativecommons.org/licenses/by/4.0/">give me attribution</a>.
            </p>

            <p>You're free to download this entire site <a href="https://github.com/nottrobin/robinwinslow.uk/">from github</a>, and <a href="http://creativecommons.org/publicdomain/zero/1.0/">do whatever you like</a> with the code.</p>

            <p><a href="https://github.com/nottrobin/robinwinslow.uk/" class="github-fork">Fork me on github.</a></p>
        </footer>
		<!--[if !(lt IE 8)]><!-->
		<script type="text/javascript">
		  (function(){
			var e = document.createElement('script'); e.type='text/javascript'; e.async = true;
			e.src = 'https://www.eff.org/ngw/widget.min.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(e, s);
		  })();
		</script>
		<!--<![endif]-->
    </body>
</html>
